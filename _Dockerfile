# Usamos la imagen base de Debian
FROM debian:bookworm-slim AS build

# Instalar dependencias necesarias para .NET 8 y Nginx
RUN apt-get update && \
    apt-get install -y \
    wget \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    nginx \
    git && \
    rm -rf /var/lib/apt/lists/*

# Agregar el repositorio de Microsoft para instalar .NET
RUN wget https://packages.microsoft.com/config/debian/11/prod.list -O /etc/apt/sources.list.d/microsoft-prod.list && \
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc | tee /etc/apt/trusted.gpg.d/microsoft.asc

# Instalar el SDK de .NET 8
RUN apt-get update && \
    apt-get install -y dotnet-sdk-8.0 && \
    rm -rf /var/lib/apt/lists/*

# Configuraci贸n de git (reemplaza "your_token" con el token real)
RUN git config --global user.name "Raptor057" && \
    git config --global user.email "rogelioarriaga@live.com.mx"

# Crear una carpeta para el repositorio y clonarlo
WORKDIR /usr/src
RUN git clone https://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@github.com/Raptor057/Medical.Office.Net8WebApi.git

# Publicar la aplicaci贸n en la carpeta para Nginx
WORKDIR /usr/src/Medical.Office.Net8WebApi/Medical.Office.Net8WebApi
RUN dotnet publish -c Release -o /var/www/medical_office

# Configuraci贸n de Nginx
RUN rm /etc/nginx/sites-enabled/default
COPY nginx.conf /etc/nginx/sites-available/medical_office
RUN ln -s /etc/nginx/sites-available/medical_office /etc/nginx/sites-enabled/

# Exponer puertos
EXPOSE 80

# Comando para iniciar la aplicaci贸n y Nginx
CMD ["sh", "-c", "service nginx start && dotnet /var/www/medical_office/Medical.Office.Net8WebApi.dll"]
